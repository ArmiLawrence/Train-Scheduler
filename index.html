<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Train Schedule</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
</head>

<body>

    <div class="container">

        <div class="jumbotron jumbotron-fluid bg-secondary text-white">
                <div class="container">
                  <h1 class="display-4">Today's Train Schedule</h1>
                  <p class="lead">Do not be late!</p>
                </div>
        </div>

        <br>
        
        <div class="container">     
            <div class="card-body">
                <table class="table" id = "train-table">
                    <thead>
                    <tr>
                        <th scope="col">Train Name</th>
                        <th scope="col">Destination</th>
                        <th scope="col">First Train Time</th>
                        <th scope="col">Frequency</th>
                        <th scope="col">Next Arrival Time</th>
                        <th scope="col">Minutes Away</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <br>

        <div class="container">
            <div class="card card-default">
                <div class="p-3 mb-2 bg-secondary text-white">
                    <nav class="navbar navbar-light bg-dark">Train Data</nav>
                        <div class="card-body">
                            <form id = "train-data">
                                <div class="form-group">
                                <label for="formGroupExampleInput">Train Name</label>
                                <input type="text" class="form-control" id="trainNameInput" placeholder="Train Name">
                                </div>
                                <div class="form-group">
                                <label for="formGroupExampleInput2">Destination</label>
                                <input type="text" class="form-control" id="destinationInput" placeholder="Destination">
                                </div>
                                <div class="form-group">
                                    <label for="formGroupExampleInput2">First Train Time (military time HH:MM)</label>
                                    <input type="text" class="form-control" id="firstTrainInput" placeholder="First Train Time">
                                </div>
                                <div class="form-group">
                                <label for="formGroupExampleInput2">Frequency (minutes)</label>
                                <input type="text" class="form-control" id="frequencyInput" placeholder="Frequency">
                                </div>
                                <button type="submit" class="btn btn-primary" id="add-train">Submit</button>
                            </form>
                        </div>
                    </div>
                </div>        
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Added Moment JS -->
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

    <!-- LINK TO FIREBASE GOES HERE -->
    <script src="https://www.gstatic.com/firebasejs/5.7.3/firebase.js"></script>

    <script type="text/javascript">
    
    // 1. Initialize Firebase
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyCDh51Aa9TWdPFB6-G4pNgWeYA0K4pvF8A",
        authDomain: "uden-bootcamp-train-schedule.firebaseapp.com",
        databaseURL: "https://uden-bootcamp-train-schedule.firebaseio.com",
        projectId: "uden-bootcamp-train-schedule",
        storageBucket: "uden-bootcamp-train-schedule.appspot.com",
        messagingSenderId: "908258763158"
    };   


    firebase.initializeApp(config);

    // Create a variable to reference the database
    var database = firebase.database();

    // Initial Values
    var nextArrivalTime = "";
    var minutesAway = "";

    function clearForm (){
        document.getElementById("train-data").reset();
    };
    
    // 2. Button for adding Train Schedule
    /// Capture Button Click
    $("#add-train").on("click", function(event) {

        event.preventDefault();

        // YOUR TASK!!!
        // Code in the logic for storing and retrieving the most recent user.
        // Don't forget to provide initial data to your Firebase database.
        var trainName = $("#trainNameInput").val().trim();
        var destination = $("#destinationInput").val().trim();
        var firstTrainTime = $("#firstTrainInput").val().trim();
        var frequency = $("#frequencyInput").val().trim();

        var newTrain = {
            train: trainName,
            trainDestination: destination,
            trainTime: firstTrainTime,
            trainFrequency: frequency
        }

        // Uploads train data to the database
        database.ref().push(newTrain);

        // Logs everything to console
        console.log(newTrain.train);
        console.log(newTrain.trainDestination);
        console.log(newTrain.trainTime);
        console.log(newTrain.trainFrequency);

        clearForm();
    });


    //3. Show stuff
    // Firebase watcher + initial loader HINT: .on("value")
    database.ref().on("child_added", function(childSnapshot) {

    // Log everything that's coming out of snapshot
    console.log(childSnapshot.val());

    var trainName = childSnapshot.val().train;
    var destination = childSnapshot.val().trainDestination;
    var firstTrainTime = childSnapshot.val().trainTime;
    var frequency = childSnapshot.val().trainFrequency;

    console.log(trainName);
    console.log(destination);
    console.log(firstTrainTime);
    console.log(frequency);


    //Add Train time remaining calculations
        // First Time (pushed back 1 year to make sure it comes before current time)
    var firstTimeConverted = moment(firstTrainTime, "HH:mm").subtract(1, "years");
    console.log(firstTimeConverted);

    // Current Time
    var currentTime = moment();
    console.log("CURRENT TIME: " + moment(currentTime).format("hh:mm"));

    // Difference between the times
    var diffTime = moment().diff(moment(firstTimeConverted), "minutes");
    console.log("DIFFERENCE IN TIME: " + diffTime);

    // Time apart (remainder)
    var tRemainder = diffTime % frequency;
    console.log(tRemainder);

    // Minute Until Train
    var tMinutesTillTrain = frequency - tRemainder;
    console.log("MINUTES TILL TRAIN: " + tMinutesTillTrain);

    // Next Train
    var nextTrain = moment().add(tMinutesTillTrain, "minutes");
    console.log("ARRIVAL TIME: " + moment(nextTrain).format("MMM DD YYYY, hh:mm a"));
    



    // Append the newly created table data to the table row
    // Create a new table row element
    var tRow = $("<tr>").append(
            $("<td>").text(trainName),
            $("<td>").text(destination),
            $("<td>").text(firstTrainTime),
            $("<td>").text(frequency),
            $("<td>").text(moment(nextTrain).format("MMM DD YYYY, hh:mm a")),
            $("<td>").text(tMinutesTillTrain),
    );

    // Append the table row to the table body
    $("#train-table > tbody").append(tRow);

    // Handle the errors
    }, function(errorObject) {
    console.log("Errors handled: " + errorObject.code);
    });

    
 

    </script>

</body>